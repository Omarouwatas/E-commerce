from pymongo import MongoClient
import pandas as pd
from datetime import datetime
import pytz

# Connexion MongoDB
client = MongoClient("mongodb://localhost:27017") 
db = client["commerce_platform"]  
orders_col = db["commandes"]
inventory_col = db["inventaire"]

# Extraction des commandes
orders_cursor = orders_col.find()
orders = list(orders_cursor)

enriched_data = []
for order in orders:
    date = order["date_commande"]
    if isinstance(date, dict) and "$date" in date:
        date = datetime.fromisoformat(date["$date"].replace("Z", "+00:00"))
    date = date.astimezone(pytz.utc)
    
    gouvernorat = order["adresse_livraison"]["gouvernorat"]
    ville = order["adresse_livraison"]["ville"]
    jour_semaine = date.weekday()
    mois = date.month
    mode_paiement = order["mode_paiement"]
    nb_produits_dans_commande = sum(p["quantite"] for p in order["produits"])
    
    for produit in order["produits"]:
        enriched_data.append({
            "product_id": produit["product_id"],
            "nom_produit": produit["nom"],
            "date_commande": date.date(),
            "jour_semaine": jour_semaine,
            "mois": mois,
            "ville": ville,
            "gouvernorat": gouvernorat,
            "mode_paiement": mode_paiement,
            "nb_produits_dans_commande": nb_produits_dans_commande,
            "quantite": produit["quantite"],
            "prix_unitaire": produit["prix"],
            "revenu": produit["quantite"] * produit["prix"]
        })

df = pd.DataFrame(enriched_data)

grouped = df.groupby([
    "product_id", "nom_produit", "date_commande", "jour_semaine", "mois",
    "ville", "gouvernorat", "mode_paiement"
]).agg({
    "quantite": "sum",
    "revenu": "sum",
    "nb_produits_dans_commande": "mean",
    "prix_unitaire": "mean"
}).reset_index()

inventory_cursor = inventory_col.find()
inventory_data = []
for item in inventory_cursor:
    date_ajout = item["date_ajout"]
    if isinstance(date_ajout, dict) and "$date" in date_ajout:
        date_ajout = datetime.fromisoformat(date_ajout["$date"].replace("Z", "+00:00"))
    inventory_data.append({
        "product_id": item["product_id"],
        "emplacement": item["emplacement"],
        "date_ajout": date_ajout.date(),
        "quantite_disponible": item["quantite_disponible"]
    })

stock_df = pd.DataFrame(inventory_data)
merged_df = pd.merge(
    grouped,
    stock_df,
    how="left",
    left_on=["product_id", "gouvernorat", "date_commande"],
    right_on=["product_id", "emplacement", "date_ajout"]
)

merged_df["quantite_disponible"] = merged_df["quantite_disponible"].fillna(0)
merged_df.drop(columns=["emplacement", "date_ajout"], inplace=True)

merged_df.to_csv("donnees_lstm.csv", index=False)
print("✅ Données enrichies exportées vers 'donnees_lstm.csv'")
